<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>üéì University Store</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
    --primary: #667eea; --secondary: #764ba2;
    --success: #27ae60; --danger: #e74c3c;
}
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(125deg, #667eea 0%, #764ba2 100%);
    color: #2c3e50; min-height: 100vh;
}
.header {
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(20px);
    padding: 1rem 2rem;
    position: fixed; width: 100%; top: 0; z-index: 1000;
}
.nav { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; }
.logo { font-size: 1.5rem; font-weight: bold; color: white; }
.admin-btn {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white; padding: 0.6rem 1.5rem; border: none;
    border-radius: 50px; cursor: pointer; font-weight: 600;
}
.hero { text-align: center; padding: 8rem 2rem 4rem; color: white; }
.hero h1 { font-size: 3rem; margin-bottom: 1rem; }
.products { padding: 3rem 2rem; }
.container { max-width: 1200px; margin: 0 auto; }
.section-title { text-align: center; font-size: 2.5rem; color: white; margin-bottom: 2rem; }
.product-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; }
.product-card {
    background: rgba(255,255,255,0.9);
    border-radius: 15px; overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    transition: transform 0.3s;
}
.product-card:hover { transform: translateY(-10px); }
.product-image {
    height: 200px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex; align-items: center; justify-content: center;
    font-size: 3rem;
}
.product-info { padding: 1.5rem; }
.product-name { font-size: 1.3rem; font-weight: bold; margin-bottom: 0.5rem; }
.product-price { font-size: 1.5rem; color: var(--primary); font-weight: bold; margin-bottom: 1rem; }
.order-now {
    width: 100%; padding: 1rem;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white; border: none; border-radius: 10px;
    font-weight: bold; cursor: pointer;
}
.modal {
    display: none; position: fixed; z-index: 2000;
    left: 0; top: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.7);
}
.modal-content {
    background: white; margin: 5% auto; padding: 2rem;
    border-radius: 15px; width: 90%; max-width: 500px;
}
.close { color: #999; float: right; font-size: 28px; cursor: pointer; }
.form-group { margin-bottom: 1rem; }
.form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
.form-group input, .form-group select, .form-group textarea {
    width: 100%; padding: 0.8rem; border: 2px solid #ddd;
    border-radius: 8px; font-size: 1rem;
}
.submit-btn {
    width: 100%; padding: 1rem;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white; border: none; border-radius: 10px;
    font-weight: bold; cursor: pointer; font-size: 1.1rem;
}
.dashboard {
    display: none; background: linear-gradient(135deg, #1a1a2e, #16213e);
    min-height: 100vh; padding: 2rem; color: white;
}
.dashboard.active { display: block; }
.dashboard-header {
    display: flex; justify-content: space-between;
    align-items: center; margin-bottom: 2rem;
    padding-bottom: 1rem; border-bottom: 2px solid rgba(255,255,255,0.1);
}
.dashboard-nav { display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; }
.dash-nav-btn {
    padding: 1rem 1.5rem; border: none; border-radius: 10px;
    cursor: pointer; font-weight: bold;
    background: rgba(255,255,255,0.1); color: white;
}
.dash-nav-btn.active {
    background: linear-gradient(135deg, #667eea, #764ba2);
}
.dashboard-section { display: none; }
.dashboard-section.active { display: block; }
.add-product-form, .orders-section, .products-list {
    background: rgba(255,255,255,0.05);
    padding: 2rem; border-radius: 15px; margin-bottom: 2rem;
}
.product-item, .order-item {
    display: flex; justify-content: space-between;
    align-items: center; padding: 1rem;
    margin-bottom: 1rem; background: rgba(255,255,255,0.05);
    border-radius: 8px;
}
.delete-btn {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white; padding: 0.5rem 1rem;
    border: none; border-radius: 8px; cursor: pointer;
}
.finalize-btn {
    background: linear-gradient(135deg, #27ae60, #229954);
    color: white; padding: 0.5rem 1rem;
    border: none; border-radius: 8px; cursor: pointer;
}
.message {
    padding: 1rem; border-radius: 8px; margin: 1rem 0;
    position: fixed; top: 100px; right: 20px; z-index: 3000;
    min-width: 250px;
}
.success-message { background: rgba(39,174,96,0.9); color: white; }
.error-message { background: rgba(231,76,60,0.9); color: white; }
.warning-message { background: rgba(241,196,15,0.9); color: white; }
</style>
</head>
<body>

<header class="header" id="header">
<nav class="nav">
<div class="logo">üéì University Store</div>
<button class="admin-btn" onclick="showLoginModal()">Connexion Admin</button>
</nav>
</header>

<main class="main-content" id="mainContent">
<section class="hero">
<h1>üéì University Store</h1>
<p>Ton style, ta technologie</p>
</section>

<section class="products">
<div class="container">
<h2 class="section-title">Nos Produits</h2>
<div class="product-grid" id="productGrid"></div>
</div>
</section>
</main>

<!-- Login Modal -->
<div class="modal" id="loginModal">
<div class="modal-content">
<span class="close" onclick="closeLoginModal()">√ó</span>
<h3 style="text-align: center; margin-bottom: 1.5rem;">Connexion Admin</h3>
<div class="form-group">
<label>Nom d'utilisateur</label>
<input id="username" type="text" required/>
</div>
<div class="form-group">
<label>Mot de passe</label>
<input id="password" type="password" required/>
</div>
<button class="submit-btn" onclick="login()">Se connecter</button>
<div class="error-message" id="loginError" style="margin-top: 1rem; display: none;"></div>
</div>
</div>

<!-- Order Modal -->
<div class="modal" id="orderModal">
<div class="modal-content">
<span class="close" onclick="closeOrderModal()">√ó</span>
<h3 style="text-align: center; margin-bottom: 1.5rem;">Passer une commande</h3>
<form id="orderFormElement">
<div class="form-group">
<label>Nom</label>
<input id="orderName" type="text" required/>
</div>
<div class="form-group">
<label>Pr√©nom</label>
<input id="orderPrenom" type="text" required/>
</div>
<div class="form-group">
<label>T√©l√©phone</label>
<input id="orderPhone" type="tel" placeholder="07XX XX XX XX" required/>
</div>
<div class="form-group">
<label>Wilaya</label>
<input id="wilaya" type="text" placeholder="Ex: S√©tif" required/>
</div>
<div class="form-group">
<label>Commune</label>
<input id="commune" type="text" placeholder="Ex: Ain Arnat" required/>
</div>
<button class="submit-btn" type="submit">Confirmer</button>
<div id="orderTotalPrice" style="margin-top:1rem; font-size:1.1rem; font-weight:bold; text-align:center;">üí∞ Total: 0 DZD</div>
</form>
</div>
</div>

<!-- Dashboard -->
<div class="dashboard" id="dashboard">
<div class="dashboard-header">
<h2>üéõÔ∏è Dashboard Admin</h2>
<button class="delete-btn" onclick="logout()">D√©connexion</button>
</div>

<div class="dashboard-nav">
<button class="dash-nav-btn active" onclick="showDashSection('products', event)">üì¶ Produits</button>
<button class="dash-nav-btn" onclick="showDashSection('orders', event)">üìã Commandes</button>
</div>

<!-- Products Section -->
<div class="dashboard-section active" id="productsSection">
<div class="add-product-form">
<h3 style="margin-bottom: 1.5rem;">Ajouter un produit</h3>
<form id="addProductForm">
<div class="form-group">
<label>Nom du produit</label>
<input id="productName" type="text" required/>
</div>
<div class="form-group">
<label>Prix (DZD)</label>
<input id="productPrice" type="number" min="1" required/>
</div>
<div class="form-group">
<label>Cat√©gorie</label>
<select id="productCategory" required>
<option value="">S√©lectionner</option>
<option value="habillement">üëî Habillement</option>
<option value="electronique">üéß √âlectronique</option>
<option value="accessoires">‚ú® Accessoires</option>
</select>
</div>
<div class="form-group">
<label>Description</label>
<textarea id="productDescription" rows="3" required></textarea>
</div>
<div class="form-group">
<label>Emoji</label>
<input id="productEmoji" type="text" placeholder="Ex: üëï"/>
</div>
<button class="submit-btn" type="submit">Ajouter</button>
</form>
</div>

<div class="products-list">
<h3 style="margin-bottom: 1.5rem;">Produits existants</h3>
<div id="productsList"></div>
</div>
</div>

<!-- Orders Section -->
<div class="dashboard-section" id="ordersSection">
<div class="orders-section">
<h3 style="margin-bottom: 1.5rem;">Commandes</h3>
<div id="ordersList"></div>
</div>
</div>
</div>

<script>
// ========== CONFIGURATION ==========
// ‚ö†Ô∏è REMPLACEZ CETTE URL PAR VOTRE URL GOOGLE APPS SCRIPT
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby6L_0wwy1kgr6MM7sr2HoP0wceoopwva1AqbQVab97XW4fI9WQQAnxQQ8lSrLo9RLf7A/exec';

const ADMIN_CREDENTIALS = {
    username: 'c2db64b7f08adc2226fe74ce748cb2a55e6e4f3e2c2fdd929960a3efd034f202',
    password: 'bbc51dcc1c1d6800ff44f0f5b8e5b7431c533ed13e1dc92c4ce5fdced1488050'
};

let products = [];
let orders = [];
let nextId = 1;
let nextOrderId = 1;
let currentOrderProduct = null;
let isAdmin = false;

// ========== SECURITY ==========
async function sha256(message) {
    const msgBuffer = new TextEncoder().encode(message);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// ========== GOOGLE SHEETS SYNC ==========
async function syncProductToSheets(product) {
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                action: 'addProduct', 
                product: product 
            })
        });
        console.log('‚úÖ Product synced to Sheets');
        return true;
    } catch (error) {
        console.error('‚ùå Sync error:', error);
        return false;
    }
}

async function syncOrderToSheets(order) {
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                action: 'addOrder', 
                order: order 
            })
        });
        console.log('‚úÖ Order synced to Sheets');
        return true;
    } catch (error) {
        console.error('‚ùå Sync error:', error);
        return false;
    }
}

async function loadProductsFromSheets() {
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getProducts');
        const result = await response.json();
        
        if (result.success && result.products && result.products.length > 0) {
            products = result.products.filter(p => p.id);
            nextId = Math.max(...products.map(p => p.id || 0)) + 1;
            saveProducts();
            displayProducts();
            if (isAdmin) displayProductsList();
            console.log('‚úÖ Loaded', products.length, 'products from Sheets');
            return true;
        } else {
            console.log('üì¶ No products in Sheets, using localStorage');
            loadProducts();
            return false;
        }
    } catch (error) {
        console.error('‚ùå Error loading from Sheets:', error);
        loadProducts();
        return false;
    }
}

async function loadOrdersFromSheets() {
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getOrders');
        const result = await response.json();
        
        if (result.success && result.orders && result.orders.length > 0) {
            orders = result.orders.filter(o => o.id);
            nextOrderId = Math.max(...orders.map(o => o.id || 0)) + 1;
            saveOrders();
            if (isAdmin) displayOrdersList();
            console.log('‚úÖ Loaded', orders.length, 'orders from Sheets');
            return true;
        } else {
            console.log('üì¶ No orders in Sheets');
            loadOrders();
            return false;
        }
    } catch (error) {
        console.error('‚ùå Error loading orders:', error);
        loadOrders();
        return false;
    }
}

async function deleteProductFromSheets(productId) {
    try {
        await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                action: 'deleteProduct', 
                productId: productId 
            })
        });
        console.log('‚úÖ Product deleted from Sheets');
    } catch (error) {
        console.error('‚ùå Delete error:', error);
    }
}

// ========== LOCAL STORAGE ==========
function saveProducts() {
    localStorage.setItem('university_store_products', JSON.stringify(products));
}

function loadProducts() {
    const saved = localStorage.getItem('university_store_products');
    if (saved) {
        products = JSON.parse(saved);
        nextId = Math.max(...products.map(p => p.id || 0), 0) + 1;
    }
}

function saveOrders() {
    localStorage.setItem('university_store_orders', JSON.stringify(orders));
}

function loadOrders() {
    const saved = localStorage.getItem('university_store_orders');
    if (saved) {
        orders = JSON.parse(saved);
        nextOrderId = Math.max(...orders.map(o => o.id || 0), 0) + 1;
    }
}

// ========== UI FUNCTIONS ==========
function displayProducts() {
    const grid = document.getElementById('productGrid');
    grid.innerHTML = '';
    
    if (products.length === 0) {
        grid.innerHTML = '<p style="color: white; text-align: center;">Aucun produit disponible</p>';
        return;
    }
    
    products.forEach(product => {
        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
            <div class="product-image">${product.emoji || 'üì¶'}</div>
            <div class="product-info">
                <div class="product-name">${product.name}</div>
                <div class="product-price">${product.price} DZD</div>
                <p style="margin-bottom: 1rem; color: #666;">${product.description}</p>
                <button class="order-now" onclick="openOrderModal(${product.id})">Commander</button>
            </div>
        `;
        grid.appendChild(card);
    });
}

function displayProductsList() {
    const list = document.getElementById('productsList');
    list.innerHTML = '';
    
    if (products.length === 0) {
        list.innerHTML = '<p style="opacity: 0.7;">Aucun produit</p>';
        return;
    }
    
    products.forEach(product => {
        const item = document.createElement('div');
        item.className = 'product-item';
        item.innerHTML = `
            <div>
                <strong>${product.emoji || 'üì¶'} ${product.name}</strong><br>
                <small style="opacity: 0.8;">${product.price} DZD - ${product.category}</small>
            </div>
            <button class="delete-btn" onclick="deleteProduct(${product.id})">Supprimer</button>
        `;
        list.appendChild(item);
    });
}

function displayOrdersList() {
    const list = document.getElementById('ordersList');
    list.innerHTML = '';
    
    if (orders.length === 0) {
        list.innerHTML = '<p style="opacity: 0.7;">Aucune commande</p>';
        return;
    }
    
    orders.forEach(order => {
        const item = document.createElement('div');
        item.className = 'order-item';
        item.style.flexDirection = 'column';
        item.style.alignItems = 'flex-start';
        item.innerHTML = `
            <div style="width: 100%;">
                <strong>Commande #${order.id}</strong> - ${order.orderDate}<br>
                <p style="margin-top: 0.5rem;">
                    <strong>Produit:</strong> ${order.productName} (${order.productPrice} DZD)<br>
                    <strong>Client:</strong> ${order.customerPrenom} ${order.customerName}<br>
                    <strong>T√©l√©phone:</strong> ${order.customerPhone}<br>
                    <strong>Adresse:</strong> ${order.commune}, ${order.wilayaName}<br>
                    <strong>Statut:</strong> <span style="color: ${order.status === 'Finalis√©e' ? '#27ae60' : '#f39c12'}">${order.status}</span>
                </p>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                ${order.status === 'En attente' ? `<button class="finalize-btn" onclick="finalizeOrder(${order.id})">Finaliser</button>` : ''}
                <button class="delete-btn" onclick="deleteOrder(${order.id})">Supprimer</button>
            </div>
        `;
        list.appendChild(item);
    });
}

function showNotification(message, type = 'success') {
    const notif = document.createElement('div');
    notif.className = `message ${type}-message`;
    notif.textContent = message;
    document.body.appendChild(notif);
    
    setTimeout(() => {
        notif.style.opacity = '0';
        setTimeout(() => notif.remove(), 300);
    }, 3000);
}

// ========== AUTHENTICATION ==========
function showLoginModal() {
    document.getElementById('loginModal').style.display = 'block';
}

function closeLoginModal() {
    document.getElementById('loginModal').style.display = 'none';
    document.getElementById('loginError').style.display = 'none';
}

async function login() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    
    const hashedUsername = await sha256(username.toLowerCase());
    const hashedPassword = await sha256(password);
    
    if (hashedUsername === ADMIN_CREDENTIALS.username && 
        hashedPassword === ADMIN_CREDENTIALS.password) {
        isAdmin = true;
        closeLoginModal();
        showDashboard();
        showNotification('Connexion r√©ussie', 'success');
    } else {
        document.getElementById('loginError').textContent = 'Identifiants incorrects';
        document.getElementById('loginError').style.display = 'block';
    }
}

function logout() {
    if (confirm('D√©connexion ?')) {
        isAdmin = false;
        hideDashboard();
        showNotification('D√©connect√©', 'success');
    }
}

// ========== DASHBOARD ==========
function showDashboard() {
    document.getElementById('mainContent').style.display = 'none';
    document.getElementById('header').style.display = 'none';
    document.getElementById('dashboard').classList.add('active');
    displayProductsList();
    displayOrdersList();
}

function hideDashboard() {
    document.getElementById('mainContent').style.display = 'block';
    document.getElementById('header').style.display = 'block';
    document.getElementById('dashboard').classList.remove('active');
}

function showDashSection(section, event) {
    document.querySelectorAll('.dashboard-section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.dash-nav-btn').forEach(b => b.classList.remove('active'));
    
    document.getElementById(section + 'Section').classList.add('active');
    if (event) event.target.classList.add('active');
}

// ========== PRODUCT MANAGEMENT ==========
async function deleteProduct(id) {
    if (!confirm('Supprimer ce produit ?')) return;
    
    products = products.filter(p => p.id !== id);
    saveProducts();
    await deleteProductFromSheets(id);
    displayProducts();
    displayProductsList();
    showNotification('Produit supprim√©', 'success');
}

// ========== ORDER MANAGEMENT ==========
function openOrderModal(productId) {
    currentOrderProduct = products.find(p => p.id === productId);
    if (!currentOrderProduct) return;
    
    document.getElementById('orderModal').style.display = 'block';
    document.getElementById('orderFormElement').reset();
    
    const total = parseInt(currentOrderProduct.price || 0) + 500;
    document.getElementById('orderTotalPrice').textContent = `üí∞ Total: ${total} DZD (+ 500 DA livraison)`;
}

function closeOrderModal() {
    document.getElementById('orderModal').style.display = 'none';
    currentOrderProduct = null;
}

function finalizeOrder(id) {
    if (!confirm('Marquer comme finalis√©e ?')) return;
    
    const order = orders.find(o => o.id === id);
    if (order) {
        order.status = 'Finalis√©e';
        saveOrders();
        displayOrdersList();
        showNotification('Commande finalis√©e', 'success');
    }
}

function deleteOrder(id) {
    if (!confirm('Supprimer cette commande ?')) return;
    
    orders = orders.filter(o => o.id !== id);
    saveOrders();
    displayOrdersList();
    showNotification('Commande supprim√©e', 'success');
}

// ========== EVENT HANDLERS ==========
document.getElementById('addProductForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const newProduct = {
        id: nextId++,
        name: document.getElementById('productName').value,
        price: parseInt(document.getElementById('productPrice').value),
        category: document.getElementById('productCategory').value,
        description: document.getElementById('productDescription').value,
        emoji: document.getElementById('productEmoji').value || 'üì¶'
    };
    
    products.push(newProduct);
    saveProducts();
    await syncProductToSheets(newProduct);
    
    displayProducts();
    displayProductsList();
    
    this.reset();
    showNotification('‚úÖ Produit ajout√© et synchronis√© !', 'success');
});

document.getElementById('orderFormElement').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!currentOrderProduct) return;
    
    const orderData = {
        id: nextOrderId++,
        productId: currentOrderProduct.id,
        productName: currentOrderProduct.name,
        productPrice: currentOrderProduct.price,
        customerName: document.getElementById('orderName').value,
        customerPrenom: document.getElementById('orderPrenom').value,
        customerPhone: document.getElementById('orderPhone').value,
        wilayaName: document.getElementById('wilaya').value,
        commune: document.getElementById('commune').value,
        orderDate: new Date().toLocaleString('fr-FR'),
        status: 'En attente'
    };
    
    orders.unshift(orderData);
    saveOrders();
    await syncOrderToSheets(orderData);
    
    closeOrderModal();
    showNotification('‚úÖ Commande enregistr√©e !', 'success');
});

// Close modals on outside click
window.onclick = function(e) {
    if (e.target.id === 'loginModal') closeLoginModal();
    if (e.target.id === 'orderModal') closeOrderModal();
}

// ========== AUTO-SYNC ==========
setInterval(async () => {
    console.log('üîÑ Auto-sync...');
    await loadProductsFromSheets();
    await loadOrdersFromSheets();
}, 2 * 60 * 1000); // Every 2 minutes

// ========== INITIALIZATION ==========
window.addEventListener('load', async function() {
    console.log('üöÄ Loading University Store...');
    
    // Try to load from Google Sheets first
    const productsLoaded = await loadProductsFromSheets();
    const ordersLoaded = await loadOrdersFromSheets();
    
    // If nothing in Sheets, use localStorage
    if (!productsLoaded) {
        loadProducts();
        displayProducts();
    }
    if (!ordersLoaded) {
        loadOrders();
    }
    
    console.log('‚úÖ Store ready!');
    console.log('üì¶ Products:', products.length);
    console.log('üìã Orders:', orders.length);
});
</script>

</body>
</html>
